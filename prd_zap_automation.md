# Product Requirements Document (PRD) - Интеграция OWASP ZAP через PowerShell/CMD

## 1. Цель и описание проекта

**Цель проекта:** Автоматизировать процесс сканирования веб-приложений на уязвимости с использованием OWASP ZAP, управляемого через скрипты PowerShell/CMD. Это позволит интегрировать сканирование безопасности в CI/CD конвейеры или выполнять его по расписанию без необходимости ручного взаимодействия с графическим интерфейсом ZAP.

**Описание проекта:** Проект включает в себя разработку набора скриптов (предпочтительно на PowerShell для кросс-платформенности и легкости интеграции в Windows-окружение, а также CMD для базовой совместимости), которые будут запускать OWASP ZAP в режиме демона или через командную строку, конфигурировать его для сканирования заданных веб-приложений, и получать отчеты о найденных уязвимостях. Скрипты должны обеспечивать гибкость в настройке параметров сканирования (например, выбор политик сканирования, включение/отключение аддонов, определение URL для сканирования) и удобный вывод результатов. Проект также включает определение необходимой архитектуры интеграции, технического стека, стандартов кодирования, спецификаций API ZAP, стратегии тестирования, схемы входных/выходных данных, процесса разработки, ведение лога решений и создание библиотеки промптов/правил для AI-ассистента, помогающего в разработке.

## 2. Глоссарий терминов

*   **OWASP ZAP (Zed Attack Proxy):** Один из самых популярных бесплатных инструментов для поиска уязвимостей в веб-приложениях. Позволяет проводить как автоматизированное, так и ручное тестирование безопасности.
*   **Automation (Автоматизация):** Процесс выполнения задач (в данном случае, сканирования безопасности) без прямого участия человека, с помощью скриптов или специализированных инструментов.
*   **Headless Mode (Безголовый режим):** Режим работы приложения (ZAP) без графического интерфейса пользователя (GUI). В этом режиме ZAP управляется исключительно через командную строку или API, что идеально подходит для автоматизации.
*   **CLI (Command-Line Interface):** Интерфейс командной строки. Позволяет взаимодействовать с программой (ZAP) путем ввода текстовых команд.
*   **API (Application Programming Interface):** Программный интерфейс приложения. Набор правил и спецификаций, по которым программы могут взаимодействовать друг с другом. ZAP предоставляет API для удаленного управления его функциями.
*   **PowerShell:** Объектно-ориентированная оболочка командной строки и скриптовый язык, разработанный Microsoft. Широко используется для автоматизации задач администрирования в Windows, а также доступен на других платформах.
*   **CMD (Command Prompt):** Стандартный интерпретатор командной строки в операционных системах Windows. Предоставляет базовые возможности для выполнения команд и скриптов.
*   **Active Scan (Активное сканирование):** Процесс, при котором ZAP активно отправляет вредоносные запросы к веб-приложению для выявления уязвимостей (например, SQL-инъекции, XSS). Может повлиять на работу приложения.
*   **Passive Scan (Пассивное сканирование):** Процесс анализа трафика, проходящего через ZAP, без отправки дополнительных запросов к приложению. Выявляет уязвимости на основе анализа ответов сервера (например, отсутствие заголовков безопасности).
*   **Spider (Паук):** Инструмент в ZAP, который автоматически обходит веб-приложение, переходя по ссылкам для обнаружения всех доступных страниц и функциональности.
*   **Alerts (Оповещения):** Уведомления о найденных ZAP уязвимостях или подозрительной активности, обычно классифицируемые по уровню риска.
*   **Report Generation (Генерация отчетов):** Функция ZAP, позволяющая экспортировать результаты сканирования в различные форматы (HTML, XML, JSON и др.) для анализа и документирования.

## 3. Архитектура интеграции

**Основные компоненты и их взаимодействие:**

*   **OWASP ZAP:** Выступает в роли сканирующего движка. Он будет запускаться в **безголовом режиме (headless mode)** через командную строку (`zap.sh` или `zap.bat`). В этом режиме ZAP не отображает графический интерфейс, что делает его идеальным для автоматизации. ZAP будет запущен как демон, предоставляя доступ к своему **API** для управления сканированием. По умолчанию ZAP API обычно доступен на порту `8080`, но этот порт должен быть настраиваемым. API используется для инициирования сканирования, проверки статуса выполнения и получения результатов.
*   **PowerShell/CMD Скрипт:** Является оркестратором процесса. Скрипт будет находиться в файловой системе и запускаться вручную или автоматически (например, планировщиком задач, CI/CD системой). Скрипт выполняет следующие действия:
    *   Запускает ZAP в безголовом режиме с указанием порта API и, возможно, пути к сессии.
    *   Использует HTTP-запросы (например, через `Invoke-RestMethod` в PowerShell) для взаимодействия с ZAP API, отправляя команды для:
        *   Загрузки или создания сессии.
        *   Установки целевого URL или контекста сканирования.
        *   Запуска Spider для обхода приложения.
        *   Запуска Active Scan.
        *   Проверки статуса выполнения Spider и Active Scan (например, через `core/view/status`).
        *   Получения списка найденных оповещений (например, через `core/view/alerts`).
        *   Генерации отчета в нужном формате (например, `core/action/generate` или другие эндпоинты аддонов отчетов).
    *   Сохраняет полученный отчет в указанное место.
    *   Останавливает ZAP (если он был запущен скриптом).
*   **Целевое веб-приложение:** Приложение, которое будет сканироваться ZAP. ZAP будет взаимодействовать с ним как прокси или напрямую, в зависимости от конфигурации и типа сканирования (Spider/Active Scan).
*   **Система хранения отчетов:** Директория в файловой системе, сетевая папка или другое хранилище, куда скрипт будет сохранять сгенерированные отчеты. Структура отчетов будет зависеть от выбранного формата (HTML, JSON, XML, SARIF и др.). Рекомендуется сохранять отчеты с понятным именованием, включающим дату сканирования и, возможно, имя целевого приложения.

**Схематичное описание потока данных:**

1.  **Вход:** Скрипт получает целевой URL веб-приложения для сканирования (как параметр командной строки, из конфигурационного файла и т.п.).
2.  **Запуск ZAP:** Скрипт запускает исполняемый файл ZAP (`zap.bat`/`zap.sh`) с параметрами для безголового режима и включенным API на заданном порту.
3.  **Конфигурация ZAP:** Скрипт отправляет команды ZAP API для настройки сканирования (например, загрузка политики сканирования, определение контекста).
4.  **Обход приложения (Spider):** Скрипт инициирует запуск Spider через ZAP API, указывая целевой URL. ZAP Spider обходит приложение и собирает список URL для сканирования. Скрипт ожидает завершения работы Spider, опрашивая API.
5.  **Активное сканирование:** После завершения Spider (или сразу, если список URL известен заранее), скрипт инициирует Active Scan через ZAP API для собранных/указанных URL. ZAP выполняет активные проверки на уязвимости. Скрипт ожидает завершения Active Scan, опрашивая API.
6.  **Получение результатов:** После завершения Active Scan, скрипт запрашивает список оповещений (найденных уязвимостей) через ZAP API.
7.  **Генерация отчета:** Скрипт отправляет команду ZAP API для генерации отчета в заданном формате (например, HTML, JSON).
8.  **Сохранение отчета:** Скрипт получает данные отчета от ZAP API и сохраняет их в файл в предопределенной директории.
9.  **Завершение:** Скрипт завершает работу, возможно, останавливая запущенный экземпляр ZAP.) 

## 4. Технический стек

*   **OWASP ZAP:** Рекомендуется использовать последнюю стабильную версию OWASP ZAP для доступа к новейшим функциям безопасности и исправлениям уязвимостей. Скрипты будут разрабатываться с учетом ZAP API актуальной версии, но должны быть по возможности обратно совместимы.
*   **PowerShell:**
    *   Минимальная версия: PowerShell 5.1 (входит в состав Windows 10 и Windows Server 2016 и более поздних версий).
    *   Рекомендованная версия: PowerShell 7.x или новее (PowerShell Core). Обеспечивает лучшую производительность, кросс-платформенность и расширенные возможности командной строки.
*   **CMD:** Используется для базового запуска ZAP исполняемого файла с необходимыми параметрами. Совместимость с любой версией CMD, доступной на поддерживаемых ОС.
*   **Поддерживаемые ОС:**
    *   Windows 10
    *   Windows 11
    *   Windows Server 2016
    *   Windows Server 2019
    *   Windows Server 2022
    *   Скрипты PowerShell (версии 7+) могут быть адаптированы для работы на Linux и macOS при условии установки PowerShell Core и наличии исполняемого файла ZAP для соответствующей ОС. Основной фокус разработки будет на Windows.
*   **Дополнительные модули/зависимости:**
    *   **OWASP ZAP:** Должен быть установлен и доступен исполняемый файл (`zap.bat` для Windows, `zap.sh` для других ОС).
    *   **PowerShell:** Встроенный командлет `Invoke-RestMethod` необходим для взаимодействия с ZAP API по HTTP. Дополнительные модули не требуются для базовой функциональности, но могут быть использованы для расширенной обработки данных (например, модули для работы с JSON/XML, если потребуется более сложный парсинг отчетов вне возможностей ZAP API).
    *   **CMD:** Не требует дополнительных зависимостей, кроме наличия исполняемого файла ZAP в переменной окружения PATH или указания полного пути к нему.

## 5. Style-гайд для кода

Данный style-гайд применяется к скриптам PowerShell и CMD, разрабатываемым в рамках проекта.

*   **Правила именования:**
    *   **PowerShell:**
        *   Функции и командлеты: Использовать PascalCase (например, `Start-ZapScan`, `Get-ZapAlerts`). Глагол должен быть из стандартного списка одобренных глаголов (Get, Set, Start, Stop, New, Add, Remove, Invoke, etc.).
        *   Переменные: Использовать camelCase (например, `$targetUrl`, `$reportPath`, `$zapApiKey`).
        *   Параметры функций: Использовать PascalCase (например, `[string]$TargetUrl`, `[int]$ApiPort`).
    *   **CMD:** Имена файлов скриптов должны быть описательными, использовать дефисы для разделения слов (например, `run-scan.cmd`). Имена переменных использовать ЗАГЛАВНЫЕ БУКВЫ с подчеркиваниями (например, `SET TARGET_URL=`).
*   **Отступы и длина строк:**
    *   Использовать 4 пробела для отступов в коде PowerShell.
    *   В CMD скриптах отступы не так критичны, но рекомендуется использовать их для улучшения читаемости (например, внутри блоков `IF`).
    *   Максимальная рекомендуемая длина строки: 120 символов. При необходимости разбивать длинные команды на несколько строк с использованием символа продолжения строки (`` ` `` для PowerShell, `^` для CMD).
*   **Комментарии и документация:**
    *   **PowerShell:**
        *   Каждая функция должна иметь блочный комментарий на основе синтаксиса справки `Get-Help` для документирования цели, параметров, примеров использования и возвращаемого значения.
        *   Использовать строчные комментарии (`#`) для пояснения неочевидных или сложных участков кода.
    *   **CMD:** Использовать строчные комментарии (`REM` или `::`) для пояснения основных шагов скрипта и логики.
*   **Логирование и обработка ошибок:**
    *   Использовать стандартные командлеты PowerShell для вывода информации:
        *   `Write-Host`: Для вывода информации пользователю в консоль.
        *   `Write-Output`: Для вывода данных, которые могут быть переданы по конвейеру.
        *   `Write-Warning`: Для вывода предупреждений.
        *   `Write-Error`: Для вывода сообщений об ошибках.
    *   Реализовать обработку ошибок с использованием блоков `Try`, `Catch`, `Finally` в PowerShell для перехвата исключений и выполнения действий по очистке.
    *   В CMD использовать `IF ERRORLEVEL` для проверки успешности выполнения команд.
    *   Лог-сообщения должны включать отметку времени и уровень сообщения (INFO, WARNING, ERROR). Пример формата: `[YYYY-MM-DD HH:MM:SS] [УРОВЕНЬ] Сообщение`.
    *   При возникновении критических ошибок, скрипт должен завершаться с ненулевым кодом выхода.

## 6. Спецификации API ZAP

Взаимодействие PowerShell/CMD скриптов с OWASP ZAP будет осуществляться через ZAP API, который доступен по HTTP/S.

*   **Основные REST-эндпоинты ZAP API:**
    Для автоматизации сканирования будут активно использоваться следующие группы эндпоинтов:
    *   **`core`:** Основные операции, такие как запуск/остановка ZAP, управление сессиями, получение оповещений, генерация отчетов.
        *   `core/action/newSession`: Создать новую сессию.
        *   `core/action/loadSession`: Загрузить существующую сессию.
        *   `core/action/saveSession`: Сохранить текущую сессию.
        *   `core/action/shutdown`: Остановить ZAP.
        *   `core/view/alerts`: Получить список оповещений.
        *   `core/view/numberOfAlerts`: Получить количество оповещений (можно фильтровать по риску).
        *   `core/view/alertsSummary`: Получить сводку по оповещениям по уровням риска (доступно в ZAP 2.7.0+).
        *   `core/action/generate`: Генерировать отчет (требует указания пути к шаблону и файлу вывода).
        *   `core/view/status`: Получить статус выполнения различных задач (например, сканирования).
    *   **`spider`:** Управление процессом обхода сайта (Spider).
        *   `spider/action/scan`: Запустить Spider для заданного URL.
        *   `spider/view/status`: Получить статус выполнения Spider.
        *   `spider/view/results`: Получить результаты работы Spider (найденные URL).
    *   **`ascan` (Active Scan):** Управление активным сканированием.
        *   `ascan/action/scan`: Запустить активное сканирование для заданного URL или контекста.
        *   `ascan/view/status`: Получить статус выполнения Active Scan.
        *   `ascan/view/scans`: Получить список запущенных активных сканирований и их статус.
        *   `ascan/view/scanProgress`: Получить прогресс выполнения конкретного активного сканирования.
        *   `ascan/action/importScanPolicy`: Импортировать политику сканирования из файла.
    *   **`context`:** Управление контекстами сканирования (для более точного определения области сканирования).
        *   `context/action/newContext`: Создать новый контекст.
        *   `context/action/includeInContext`: Добавить URL или regex в контекст.
        *   `context/action/excludeFromContext`: Исключить URL или regex из контекста.
        *   `context/view/contextList`: Получить список доступных контекстов.

*   **Форматы запросов и ответов:**
    ZAP API поддерживает различные форматы, включая JSON, XML, HTML, TEXT, SWAGGER. В рамках данного проекта предпочтительным форматом для взаимодействия скриптов с API будет **JSON** благодаря его легкости обработки в PowerShell с использованием командлета `ConvertFrom-Json`.

*   **Примеры HTTP-запросов (PowerShell):**
    Примеры используют `Invoke-RestMethod` и предполагают, что ZAP запущен с API на `http://localhost:8080/`. API Key должен быть включен и передан в заголовке или как параметр URL (рекомендуется заголовок).

    *   Запуск Spider:
        ```powershell
        $zapApiUrl = "http://localhost:8080"
        $apiKey = "YOUR_API_KEY" # Замените на реальный API Key
        $targetUrl = "http://testphp.vulnweb.com/" # Целевой URL

        $headers = @{"X-ZAP-API-Key" = $apiKey}
        $uri = "$zapApiUrl/JSON/spider/action/scan/?url=$targetUrl"

        Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        ```
    *   Проверка статуса Active Scan (требуется ID сканирования):
        ```powershell
        $zapApiUrl = "http://localhost:8080"
        $apiKey = "YOUR_API_KEY"
        $scanId = "1" # ID запущенного сканирования

        $headers = @{"X-ZAP-API-Key" = $apiKey}
        $uri = "$zapApiUrl/JSON/ascan/view/status/?scanId=$scanId"

        Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        ```
    *   Получение оповещений (в JSON):
        ```powershell
        $zapApiUrl = "http://localhost:8080"
        $apiKey = "YOUR_API_KEY"

        $headers = @{"X-ZAP-API-Key" = $apiKey}
        $uri = "$zapApiUrl/JSON/core/view/alerts/"

        $alerts = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        $alerts.alerts | ForEach-Object {
            Write-Host "Risk: $($_.risk) | Name: $($_.name) | URL: $($_.url)"
        }
        ```
    *   Генерация отчета (например, в HTML):
        ```powershell
        $zapApiUrl = "http://localhost:8080"
        $apiKey = "YOUR_API_KEY"
        $reportTemplate = "traditionalhtml" # Или путь к файлу шаблона
        $reportFileName = "scan_report_$(Get-Date -Format 'yyyyMMdd_HHmmss').html"
        $reportDir = "C:\ScanReports" # Директория для сохранения
        $reportPath = Join-Path $reportDir $reportFileName

        # Убедимся, что директория существует
        If (-not (Test-Path $reportDir)) {
            New-Item -Path $reportDir -ItemType Directory | Out-Null
        }

        $headers = @{"X-ZAP-API-Key" = $apiKey}
        # Параметры generate могут варьироваться в зависимости от аддона отчетов
        # Пример для core/action/generate (может потребоваться аддон Report Generation)
        # Более современные аддоны могут иметь свои эндпоинты, например report/action/generate
        $uri = "$zapApiUrl/OTHER/core/action/generate/?filepath=$reportPath&template=$reportTemplate"

        # Для эндпоинтов, возвращающих файл напрямую (например, report/action/generate)
        # Используйте Invoke-WebRequest и сохраните контент
        # $uri = "$zapApiUrl/OTHER/report/action/generate/"
        # $params = @{
        #     "template" = $reportTemplate;
        #     "reportFileName" = $reportFileName
        # }
        # Invoke-WebRequest -Uri $uri -Method Post -Body $params -Headers $headers -OutFile $reportPath

        # Пока используем эндпоинт core/action/generate для примера
         Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
         Write-Host "Отчет сохранен в: $reportPath"
        ```

*   **Настройки аутентификации:**
    Для обеспечения безопасности доступа к ZAP API, особенно когда ZAP запущен в безголовом режиме, необходимо использовать **API Key**.
    *   API Key генерируется в настройках ZAP.
    *   Для каждого запроса к API необходимо включать API Key либо в заголовок `X-ZAP-API-Key`, либо как параметр запроса `apikey`. Рекомендуется использовать заголовок `X-ZAP-API-Key` как более безопасный способ, так как ключ не попадает в логи веб-сервера.
    *   В скриптах API Key должен храниться безопасно, например, в переменных окружения или в защищенном конфигурационном файле, а не жестко закодирован в скрипте.

## 7. Стратегия тестирования

Стратегия тестирования направлена на обеспечение надежности, корректности и удобства использования разработанных скриптов для автоматизации сканирования с помощью OWASP ZAP.

*   **Цель тестирования:**
    *   Проверить корректность запуска и остановки OWASP ZAP скриптами.
    *   Убедиться в правильности взаимодействия скриптов с ZAP API (отправка запросов, получение и обработка ответов).
    *   Протестировать различные сценарии сканирования, включая Spider и Active Scan, с разными параметрами и целевыми URL.
    *   Обеспечить корректную обработку ошибок и исключительных ситуаций (например, недоступность ZAP, ошибки API, некорректные входные данные).
    *   Проверить успешность генерации и сохранения отчетов в различных форматах.
    *   Подтвердить совместимость скриптов с заявленными версиями PowerShell/CMD и операционными системами.

*   **Области тестирования:**
    *   Функции запуска и управления ZAP.
    *   Функции взаимодействия с ZAP API (`Invoke-RestMethod`/`curl` и парсинг ответов).
    *   Сценарии запуска Spider.
    *   Сценарии запуска Active Scan.
    *   Функционал получения и обработки оповещений.
    *   Функционал генерации и сохранения отчетов.
    *   Обработка входных параметров скриптов (URL, API Key, формат отчета и т.д.).
    *   Логирование и обработка ошибок.

*   **Виды тестирования:**
    *   **Unit-тестирование:** Тестирование отдельных функций или небольших блоков кода скриптов (например, функций для форматирования URL, парсинга JSON-ответов, подготовки HTTP-заголовков). Для PowerShell может быть использован фреймворк Pester.
    *   **Интеграционное тестирование:** Тестирование взаимодействия скриптов с работающим экземпляром ZAP. Включает проверку успешного вызова API эндпоинтов и корректности получаемых данных. Для этого потребуется поднять тестовый экземпляр ZAP.
    *   **Сквозное тестирование (End-to-End Testing):** Проверка полного цикла работы скрипта, от запуска ZAP (если необходимо) до получения и сохранения финального отчета для тестового веб-приложения.
    *   **Тестирование на ошибках и граничные условия:** Проверка поведения скриптов при некорректных входных данных, сетевых ошибках, ошибках ZAP API, отсутствии прав доступа к файлам и т.п.
    *   **Тестирование совместимости:** Запуск скриптов в различных поддерживаемых окружениях (разные версии PowerShell, Windows Server).
    *   **Регрессионное тестирование:** Повторное выполнение набора основных тестов после любых изменений в коде скриптов для обнаружения случайно внесенных дефектов.

*   **Тестовая среда:**
    *   Установленный OWASP ZAP рекомендованной версии.
    *   Тестовое веб-приложение, доступное по сети (желательно специально разработанное или известное уязвимое приложение для прогнозируемых результатов сканирования).
    *   Рабочие станции/серверы с поддерживаемыми версиями Windows и PowerShell/CMD.
    *   Необходимые сетевые разрешения для запуска ZAP, взаимодействия с его API и доступа к целевому веб-приложению.

*   **Автоматизация тестирования:**
    Большинство тестов, особенно Unit- и интеграционные тесты, должны быть автоматизированы. Это позволит быстро и эффективно проверять изменения в коде и интегрировать проверки в процесс CI/CD. Сквозные тесты также должны быть автоматизированы для регулярных проверок полного функционала.

## 8. Схема данных (вход/выход)

В этом разделе описываются типы данных и их форматы, которые используются скриптами для управления ZAP и получения результатов сканирования.

*   **Входные данные для скрипта:**
    Скрипт должен принимать следующие параметры для настройки сканирования:
    *   `TargetUrl` (string, обязательный): URL целевого веб-приложения для сканирования (например, `http://testphp.vulnweb.com/`).
    *   `ZapApiKey` (string, обязательный): API Key для аутентификации запросов к ZAP API. Рекомендуется передавать через переменную окружения или защищенный файл конфигурации.
    *   `ZapApiPort` (int, опциональный): Порт, на котором слушает ZAP API (по умолчанию 8080).
    *   `ReportFormat` (string, опциональный): Формат выходного отчета (например, "HTML", "JSON", "SARIF"). По умолчанию "HTML".
    *   `ReportPath` (string, опциональный): Полный путь к файлу, куда будет сохранен отчет. Если не указан, используется директория по умолчанию с автоматическим именем файла.
    *   `ScanPolicy` (string, опциональный): Имя или путь к файлу политики сканирования ZAP для применения.
    *   `ContextName` (string, опциональный): Имя контекста ZAP для использования в сканировании.
    *   `IncludeRegex` (string, опциональный): Регулярное выражение для включения URL в область сканирования.
    *   `ExcludeRegex` (string, опциональный): Регулярное выражение для исключения URL из области сканирования.

*   **Выходные данные из ZAP API:**
    Основные данные, получаемые от ZAP API, будут в формате JSON (или XML, если выбрано). Примеры структур данных:
    *   **Статус выполнения сканирования (`spider/view/status`, `ascan/view/status`):**
        Ответ в формате JSON, содержащий статус выполнения (например, процент завершения).
        ```json
        {
          "status": "100"
        }
        ```
    *   **Список оповещений (`core/view/alerts`):**
        Ответ в формате JSON, представляющий собой массив объектов, каждый из которых описывает найденную уязвимость.
        ```json
        {
          "alerts": [
            {
              "sourceid": "3",
              "pluginid": "10021",
              "alertRef": "10021-1",
              "alert": "SQL Injection - Generic",
              "name": "SQL Injection - Generic",
              "risk": "High",
              "confidence": "High",
              "url": "http://testphp.vulnweb.com/listproducts.php?cat=1",
              "method": "GET",
              "param": "cat",
              "other": "",
              "attack": "'",
              "evidence": "",
              "description": "The ZAP active scanner did not ...",
              "instances": [
                {
                  "uri": "http://testphp.vulnweb.com/listproducts.php?cat=1",
                  "method": "GET",
                  "param": "cat",
                  "attack": "'",
                  "evidence": ""
                }
              ],
              "solution": "Ensure that ...",
              "references": "https://owasp.org/www-community/attacks/SQL_Injection",
              "cweid": "89",
              "wascid": "19",
              "correlationId": ""
            }
            // ... другие оповещения
          ]
        }
        ```
    *   **Сводка оповещений (`core/view/alertsSummary`):**
        Ответ в формате JSON с количеством оповещений по уровням риска.
        ```json
        {
          "High": 5,
          "Medium": 10,
          "Low": 20,
          "Informational": 50
        }
        ```

*   **Выходные данные (отчет):**
    Финальный отчет будет сгенерирован ZAP и сохранен скриптом в указанный файл. Формат и структура отчета зависят от выбранного `ReportFormat` и шаблона отчета ZAP. Примеры форматов:
    *   **HTML:** Форматированный HTML-файл, удобный для просмотра в браузере. Содержит сводку, список оповещений с деталями, ссылки на CWE/WASC.
    *   **JSON:** JSON-файл, содержащий структуру данных оповещений, аналогичную `core/view/alerts`, но может включать дополнительную информацию в зависимости от шаблона. Удобен для машинной обработки.
    *   **XML:** XML-файл с аналогичным JSON содержанием.
    *   **SARIF:** Стандартизированный формат обмена результатами статического анализа безопасности, удобен для интеграции с другими инструментами DevSecOps.

Структура выходного файла отчета определяется шаблонами отчетов OWASP ZAP. Скрипт отвечает за вызов соответствующего API эндпоинта для генерации отчета и сохранения полученных данных в файл. 

## 9. Процесс разработки и рабочие артефакты

Данный раздел описывает предлагаемый процесс разработки и управления проектом, а также перечень создаваемых артефактов.

*   **Методология разработки:** Проект будет следовать принципам Agile, используя короткие итерации (спринты) для постепенного добавления функциональности и получения обратной связи.
*   **Управление задачами:** Для отслеживания задач, ошибок и прогресса может быть использована система управления проектами (например, Jira, Trello, GitHub Projects). Задачи будут детализированы на уровне отдельных скриптов, функций или интеграционных шагов.
*   **Система контроля версий:** Исходный код скриптов и файл PRD будут храниться в репозитории Git (например, на GitHub, GitLab, Azure Repos). Использоваться будет стандартный рабочий процесс Git Flow или Feature Branching.
*   **Рабочие артефакты:**
    *   **Product Requirements Document (PRD):** Текущий документ, содержащий требования, архитектуру, стек, стандарты и другие аспекты проекта.
    *   **Исходный код скриптов:** Файлы скриптов PowerShell (.ps1) и CMD (.cmd).
    *   **Тесты:** Скрипты или файлы конфигурации для автоматизированного тестирования (например, Pester тесты).
    *   **Файлы конфигурации ZAP:** Например, политики сканирования (.policy) или контексты (.context), если они будут управляться вне скриптов.
    *   **Примеры отчетов:** Сгенерированные отчеты в различных форматах для демонстрации и отладки.
    *   **Документация по использованию:** Инструкции для конечных пользователей по запуску и настройке скриптов.
    *   **Лог принятых решений:** Документ, фиксирующий ключевые технические и продуктовые решения.
    *   **Библиотека промптов для AI:** Документ с примерами промптов для помощи AI в разработке.
*   **Процесс Code Review:** Все изменения в коде перед слиянием в основную ветку должны проходить процедуру Code Review.
*   **CI/CD интеграция (опционально):** Настройка конвейеров CI/CD для автоматического запуска тестов скриптов и, возможно, выполнения сканирований после сборки или развертывания приложения. Для этого могут использоваться GitHub Actions, Azure Pipelines, Jenkins и т.п.

## 10. Лог принятых решений

В этом разделе будут фиксироваться ключевые решения, принятые в ходе проектирования и разработки проекта, с указанием даты, описания решения и его обоснования. Это поможет отслеживать эволюцию проекта и понимать причины тех или иных проектных решений.

*   **[Дата]: Выбор PowerShell как основного языка scripting-а.**
    *   **Обоснование:** Выбран благодаря лучшей поддержке сложных операций, нативной работе с REST API через `Invoke-RestMethod`, развитой экосистеме модулей и лучшей читаемости/поддерживаемости по сравнению с CMD для нетривиальных задач. Обеспечивает лучшую кросс-платформенность через PowerShell Core.
*   **[Дата]: Использование ZAP API в режиме демона.**
    *   **Обоснование:** Позволяет управлять ZAP удаленно и автоматизировать задачи без необходимости взаимодействия с GUI. Является стандартным подходом для интеграции ZAP в автоматизированные рабочие процессы.
*   **[Дата]: Выбор JSON в качестве основного формата обмена данными с ZAP API.**
    *   **Обоснование:** JSON является легковесным и широко используемым форматом, который удобно парсить в PowerShell с использованием встроенных средств.
*   **[Дата]: Аутентификация через API Key в заголовке `X-ZAP-API-Key`.**
    *   **Обоснование:** Обеспечивает более безопасную передачу API Key по сравнению с включением его в URL запроса, так как он не попадает в логи веб-сервера.
*   **[Дата]: ...** (placeholder для будущих решений)

## 11. Библиотека промптов для AI

Этот раздел содержит коллекцию примеров промптов, которые могут быть использованы AI-ассистентом (например, Cursor) для помощи в разработке скриптов, написании документации, генерации тестов и выполнения других задач, связанных с проектом.

*   **Промпты для генерации кода PowerShell:**
    *   `Напиши PowerShell скрипт для запуска OWASP ZAP в headless режиме на порту 8081 с API Key из переменной окружения ZAP_API_KEY.`
    *   `Создай функцию PowerShell, которая принимает URL и API Key и вызывает ZAP API для запуска Spider сканирования.`
    *   `Напиши PowerShell скрипт, который опрашивает ZAP API (эндпоинт ascan/view/status) и ждет завершения активного сканирования с заданным ID.`
    *   `Реализуй в PowerShell функцию для парсинга JSON ответа от ZAP API (core/view/alerts) и вывода списка High-рисковых уязвимостей.`
    *   `Напиши фрагмент кода PowerShell для сохранения текстовых данных в файл с автоматической генерацией имени файла на основе текущей даты и времени.`
*   **Промпты для документации:**
    *   `Сгенерируй документацию в формате markdown для PowerShell функции 'Invoke-ZapApiRequest' с описанием параметров -Uri, -Method, -Body и -Headers.`
    *   `Опиши процесс установки OWASP ZAP и его запуск в headless режиме для документации пользователя.`
*   **Промпты для тестирования:**
    *   `Напиши Pester тест для PowerShell функции 'Start-ZapScan', который проверяет, что функция вызывает внешний процесс с корректными аргументами.`
    *   `Создай мок (mock) для командлета Invoke-RestMethod в Pester для имитации ответа ZAP API на запрос статуса сканирования.`
*   **Промпты для устранения ошибок:**
    *   `Проанализируй следующий PowerShell скрипт и найди потенциальные ошибки при работе с ZAP API: [вставить код]`
    *   `Объясни, почему вызов ZAP API core/action/generate возвращает ошибку 404, и предложи возможные решения.`

## 12. Правила для AI-ассистента

Данный раздел описывает принципы взаимодействия и поведения AI-ассистента (такого как Cursor) при работе над проектом интеграции OWASP ZAP.

*   **Приоритизация задач:** AI должен приоритизировать задачи, связанные с написанием и отладкой скриптов PowerShell/CMD, взаимодействием с ZAP API и генерацией отчетов.
*   **Использование инструментов:** AI должен активно использовать доступные инструменты (такие как чтение файлов, поиск по кодовой базе, выполнение команд в терминале, поиск в документации ZAP) для получения необходимой информации и выполнения задач.
*   **Соблюдение Style-гайда:** Генерируемый AI код (PowerShell, CMD) должен строго соответствовать Style-гайду, определенному в разделе 5.
*   **Безопасность:** AI должен быть осведомлен о вопросах безопасности при работе с инструментами пентеста и API Key. Не следует жестко кодировать чувствительные данные в генерируемом коде. При работе с потенциально опасными командами или файлами AI должен действовать с осторожностью и, при необходимости, запрашивать подтверждение пользователя.
*   **Документирование:** AI должен способствовать документированию кода и решений, при необходимости создавая или обновляя соответствующие разделы PRD или комментарии в коде.
*   **Вопросы и уточнения:** В случае неясности требований или недостатка информации, AI должен задавать уточняющие вопросы пользователю, а не делать необоснованные предположения.
*   **Использование библиотеки промптов:** AI может использовать или расширять библиотеку промптов (раздел 11) для улучшения своего взаимодействия и эффективности.
*   **Логирование решений:** AI должен напоминать о необходимости фиксировать ключевые проектные решения в разделе 10. 